<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>学生成绩管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{
            --primary:#3498db; --accent:#27ae60; --danger:#e74c3c; --muted:#95a5a6;
            --bg:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);
            --card:#ffffff; --shadow:0 6px 18px rgba(0,0,0,0.08);
            --transition:all .22s ease;
        }
        *{box-sizing:border-box}
        body{font-family: "Segoe UI", Tahoma, sans-serif; margin:0; background:var(--bg); color:#222; min-height:100vh;}
        .container{max-width:1200px; margin:24px auto; padding:16px;}
        header{display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:14px 18px; border-radius:12px; box-shadow:var(--shadow); transition:var(--transition);}
        .logo{display:flex; gap:12px; align-items:center}
        .logo-icon{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;background:linear-gradient(135deg,#3498db,#2c3e50); box-shadow:0 6px 14px rgba(0,0,0,0.08)}
        .logo-text h1{margin:0;font-size:1.2rem}
        .controls{display:flex; gap:10px; align-items:center}
        .btn{padding:9px 14px;border-radius:8px;border:none;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:var(--transition)}
        .btn-primary{background:linear-gradient(135deg,#27ae60,#3498db); color:#fff}
        .btn-ghost{background:transparent; border:1px solid #e6e6e6}
        .main{display:grid; grid-template-columns:1fr 320px; gap:18px; margin-top:18px}
        .card{background:var(--card); border-radius:12px; box-shadow:var(--shadow); overflow:hidden}
        .card-header{padding:14px 16px; background:linear-gradient(135deg,#3498db,#2c3e50); color:#fff; display:flex; justify-content:space-between; align-items:center}
        .card-body{padding:16px}
        .search-row{display:flex; gap:10px; margin-bottom:12px}
        .search-row input, .form-input{padding:10px 12px; border-radius:8px; border:1px solid #e6e6e6; width:100%}
        table{width:100%; border-collapse:collapse; font-size:0.95rem}
        thead th{background:#fafafa; font-weight:600; padding:10px; text-align:left; border-bottom:1px solid #eee}
        tbody td{padding:10px; border-bottom:1px solid #f2f2f2}
        .grade{display:inline-block;padding:6px 10px;border-radius:16px;font-weight:600}
        .grade-a{background:#e8f5e9;color:#2e7d32}
        .grade-b{background:#f7fbe9;color:#7b7b00}
        .grade-c{background:#fff7e6;color:#b35f00}
        .grade-d{background:#fff0f0;color:#b71c1c}
        .action-btn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
        .action-edit{background:#3498db;color:#fff}
        .action-delete{background:#e74c3c;color:#fff}
        .sidebar .card-body{padding:12px}
        .stat-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f2f2f2}
        footer{text-align:center;color:var(--muted);margin-top:18px}

        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:1200}
        .modal.show{display:flex}
        .modal-content{background:#fff;border-radius:10px;padding:18px;width:92%;max-width:520px;box-shadow:0 18px 45px rgba(0,0,0,0.25)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .form-row{display:flex;gap:10px}
        .form-row .form-input{flex:1}
        .small{font-size:0.88rem;color:var(--muted)}

        @media (max-width:900px){
            .main{grid-template-columns:1fr}
            .controls{flex-wrap:wrap}
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-graduation-cap"></i></div>
                <div class="logo-text">
                    <h1>学生成绩管理系统</h1>
                    <div class="small">简洁高效的成绩管理解决方案</div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-ghost" id="exportCsvBtn"><i class="fas fa-download"></i>导出CSV</button>
                <button class="btn btn-primary" id="addStudentBtn"><i class="fas fa-plus"></i>添加学生</button>
            </div>
        </header>

        <div class="main">
            <div class="card">
                <div class="card-header">
                    <div style="display:flex;gap:10px;align-items:center">
                        <i class="fas fa-table"></i>
                        <span>学生成绩列表</span>
                    </div>
                    <div class="small">共 <span id="totalCount">0</span> 人</div>
                </div>
                <div class="card-body">
                    <div class="search-row">
                        <input id="searchInput" placeholder="搜索学号或姓名..." aria-label="搜索学生">
                        <select id="sortSelect" style="width:160px;border-radius:8px;padding:10px;border:1px solid #e6e6e6">
                            <option value="none">排序: 无</option>
                            <option value="avg-desc">平均分 降序</option>
                            <option value="avg-asc">平均分 升序</option>
                            <option value="name-asc">姓名 A→Z</option>
                            <option value="name-desc">姓名 Z→A</option>
                        </select>
                    </div>

                    <div style="overflow:auto;max-height:480px">
                        <table aria-describedby="学生列表">
                            <thead>
                                <tr>
                                    <th>学号</th><th>姓名</th><th>班级</th><th>数学</th><th>语文</th><th>英语</th><th>平均分</th><th>等级</th><th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="studentTbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <aside class="sidebar">
                <div class="card">
                    <div class="card-header"><i class="fas fa-chart-pie"></i><span>班级统计</span></div>
                    <div class="card-body" id="statsBody">
                        <div class="stat-item"><span>学生总数</span><strong id="statCount">0</strong></div>
                        <div class="stat-item"><span>班级平均分</span><strong id="statAvg">0</strong></div>
                        <div class="stat-item"><span>及格率</span><strong id="statPass">0%</strong></div>
                        <div style="margin-top:10px;font-size:0.9rem;color:var(--muted)">点击行可高亮，右侧按钮支持编辑和删除。</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><i class="fas fa-users"></i><span>常用操作</span></div>
                    <div class="card-body">
                        <button id="clearAll" class="btn btn-ghost" style="width:100%; margin-bottom:8px">清空所有记录</button>
                        <button id="importSample" class="btn btn-primary" style="width:100%">导入示例数据</button>
                    </div>
                </div>
            </aside>
        </div>

        <footer>学生成绩管理系统 &copy; 2023</footer>
    </div>

    <div class="modal" id="studentModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content" role="document">
            <div class="modal-header">
                <h3 id="modalTitle">添加学生</h3>
                <button class="close-modal" aria-label="关闭">&times;</button>
            </div>
            <form id="studentForm">
                <input type="hidden" id="editIndex" value="-1">
                <div class="form-row" style="margin-bottom:8px">
                    <input id="sid" class="form-input" placeholder="学号 (必填)" required>
                    <input id="name" class="form-input" placeholder="姓名 (必填)" required>
                </div>
                <div class="form-row" style="margin-bottom:8px">
                    <input id="clazz" class="form-input" placeholder="班级">
                    <input id="math" class="form-input" type="number" min="0" max="100" placeholder="数学">
                </div>
                <div class="form-row" style="margin-bottom:12px">
                    <input id="chinese" class="form-input" type="number" min="0" max="100" placeholder="语文">
                    <input id="english" class="form-input" type="number" min="0" max="100" placeholder="英语">
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end">
                    <button type="button" class="btn btn-ghost close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'sgs_students_v1';
        let students = [];

        const sample = [
            {sid:'S2023001', name:'张三', clazz:'三年二班', math:92, chinese:88, english:95},
            {sid:'S2023002', name:'李四', clazz:'三年二班', math:85, chinese:90, english:82},
            {sid:'S2023003', name:'王五', clazz:'三年一班', math:78, chinese:82, english:75},
            {sid:'S2023004', name:'赵六', clazz:'三年一班', math:65, chinese:72, english:68},
            {sid:'S2023005', name:'钱七', clazz:'三年二班', math:95, chinese:92, english:96}
        ];

        const tbody = document.getElementById('studentTbody');
        const totalCount = document.getElementById('totalCount');
        const statCount = document.getElementById('statCount');
        const statAvg = document.getElementById('statAvg');
        const statPass = document.getElementById('statPass');
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');

        const modal = document.getElementById('studentModal');
        const addBtn = document.getElementById('addStudentBtn');
        const closeBtns = document.querySelectorAll('.close-modal');
        const form = document.getElementById('studentForm');
        const sidInput = document.getElementById('sid');
        const nameInput = document.getElementById('name');
        const clazzInput = document.getElementById('clazz');
        const mathInput = document.getElementById('math');
        const chineseInput = document.getElementById('chinese');
        const englishInput = document.getElementById('english');
        const editIndexInput = document.getElementById('editIndex');
        const exportBtn = document.getElementById('exportCsvBtn');
        const clearAllBtn = document.getElementById('clearAll');
        const importSampleBtn = document.getElementById('importSample');

        function avgScore(s){ return +( ((s.math||0) + (s.chinese||0) + (s.english||0)) / 3 ).toFixed(1) }
        function gradeLabel(avg){
            if (avg>=90) return ['A','grade-a'];
            if (avg>=80) return ['B','grade-b'];
            if (avg>=70) return ['C','grade-c'];
            return ['D','grade-d'];
        }

        function load(){
            try{
                const raw = localStorage.getItem(STORAGE_KEY);
                students = raw ? JSON.parse(raw) : [];
            }catch(e){ students = [] }
            render();
        }
        function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(students)); }

        function render(){
            const q = (searchInput.value||'').trim().toLowerCase();
            let list = students.filter(s => {
                if(!q) return true;
                return (s.sid+s.name+s.clazz).toLowerCase().includes(q);
            });

            const sort = sortSelect.value;
            list.forEach(s=> s._avg = avgScore(s));
            if(sort==='avg-desc') list.sort((a,b)=> b._avg - a._avg);
            else if(sort==='avg-asc') list.sort((a,b)=> a._avg - b._avg);
            else if(sort==='name-asc') list.sort((a,b)=> a.name.localeCompare(b.name));
            else if(sort==='name-desc') list.sort((a,b)=> b.name.localeCompare(a.name));

            tbody.innerHTML = '';
            list.forEach((s, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(s.sid)}</td>
                    <td>${escapeHtml(s.name)}</td>
                    <td>${escapeHtml(s.clazz||'')}</td>
                    <td>${valOrEmpty(s.math)}</td>
                    <td>${valOrEmpty(s.chinese)}</td>
                    <td>${valOrEmpty(s.english)}</td>
                    <td>${s._avg}</td>
                    <td><span class="grade ${gradeLabel(s._avg)[1]}">${gradeLabel(s._avg)[0]}</span></td>
                    <td>
                        <button class="action-btn action-edit" data-idx="${idx}" title="编辑"><i class="fas fa-edit"></i></button>
                        <button class="action-btn action-delete" data-idx="${idx}" title="删除"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tr.addEventListener('click', (e)=>{
                    if(!e.target.closest('.action-btn')) {
                        tr.style.backgroundColor = '#f0f8ff';
                        setTimeout(()=> tr.style.backgroundColor = '', 400);
                    }
                });
                tbody.appendChild(tr);
            });

            totalCount.textContent = students.length;
            statCount.textContent = students.length;
            const allAvg = students.length ? (students.reduce((a,s)=> a + avgScore(s),0) / students.length) : 0;
            statAvg.textContent = allAvg ? allAvg.toFixed(1) : '0';
            const passCount = students.filter(s => avgScore(s) >= 60).length;
            statPass.textContent = students.length ? Math.round(passCount / students.length * 100) + '%' : '0%';

            tbody.querySelectorAll('.action-edit').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const listIdx = Number(btn.dataset.idx);
                    openEdit(list[listIdx]);
                });
            });
            tbody.querySelectorAll('.action-delete').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const listIdx = Number(btn.dataset.idx);
                    const item = list[listIdx];
                    if(confirm(`确定删除 ${item.name} (${item.sid}) 吗？`)) {
                        students = students.filter(s=> !(s.sid === item.sid));
                        save();
                        render();
                    }
                });
            });
        }

        function valOrEmpty(v){ return (v===undefined||v===null||v==='') ? '' : v }
        function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

        function openModal(){
            modal.classList.add('show');
            sidInput.focus();
            document.addEventListener('keydown', escClose);
        }
        function closeModal(){
            modal.classList.remove('show');
            form.reset();
            editIndexInput.value = -1;
            document.removeEventListener('keydown', escClose);
        }
        function escClose(e){ if(e.key === 'Escape') closeModal(); }

        function openEdit(item){
            editIndexInput.value = item.sid;
            sidInput.value = item.sid;
            nameInput.value = item.name;
            clazzInput.value = item.clazz || '';
            mathInput.value = item.math ?? '';
            chineseInput.value = item.chinese ?? '';
            englishInput.value = item.english ?? '';
            document.getElementById('modalTitle').textContent = '编辑学生';
            openModal();
        }

        form.addEventListener('submit', function(e){
            e.preventDefault();
            const sid = sidInput.value.trim();
            const name = nameInput.value.trim();
            if(!sid || !name){ alert('学号和姓名为必填项'); return; }
            const payload = {
                sid,
                name,
                clazz: clazzInput.value.trim(),
                math: numberOrNull(mathInput.value),
                chinese: numberOrNull(chineseInput.value),
                english: numberOrNull(englishInput.value)
            };
            const editingSid = editIndexInput.value;
            if(editingSid && editingSid !== '-1'){
                const idx = students.findIndex(s=> s.sid === editingSid);
                if(idx >= 0){
                    if(editingSid !== sid && students.some(s=> s.sid === sid)){
                        alert('学号已存在');
                        return;
                    }
                    students[idx] = payload;
                }
            } else {
                if(students.some(s=> s.sid === sid)){ alert('学号已存在'); return; }
                students.push(payload);
            }
            save();
            closeModal();
            render();
            document.getElementById('modalTitle').textContent = '添加学生';
        });

        function numberOrNull(v){
            if(v === '' || v === null || v === undefined) return null;
            const n = Number(v);
            return Number.isFinite(n) ? Math.max(0, Math.min(100, Math.round(n))) : null;
        }

        addBtn.addEventListener('click', ()=>{
            editIndexInput.value = -1;
            document.getElementById('modalTitle').textContent = '添加学生';
            form.reset();
            openModal();
        });
        closeBtns.forEach(b => b.addEventListener('click', closeModal));
        window.addEventListener('click', (e)=> { if(e.target === modal) closeModal(); });

        searchInput.addEventListener('input', () => render());
        sortSelect.addEventListener('change', () => render());

        exportBtn.addEventListener('click', ()=>{
            if(!students.length){ alert('无数据可导出'); return; }
            const header = ['学号','姓名','班级','数学','语文','英语','平均分'];
            const rows = students.map(s=> [s.sid, s.name, s.clazz||'', s.math??'', s.chinese??'', s.english??'', avgScore(s)]);
            const csv = [header, ...rows].map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\r\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'students.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        clearAllBtn.addEventListener('click', ()=>{
            if(confirm('确认清空所有学生记录？')) {
                students = [];
                save();
                render();
            }
        });

        importSampleBtn.addEventListener('click', ()=>{
            if(confirm('将导入示例数据，会追加到现有数据，重复学号会被替换，确认？')){
                sample.forEach(s=>{
                    const idx = students.findIndex(x=> x.sid === s.sid);
                    if(idx>=0) students[idx] = s; else students.push(s);
                });
                save(); render();
            }
        });

        (function init(){
            if(!localStorage.getItem(STORAGE_KEY)) {
                students = sample.slice();
                save();
            }
            load();
        })();

    </script>
</body>
</html>